{% extends "base.html" %}

{% block title %}Pedidos - Vulnerable Sales Dashboard{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1><i class="fas fa-shopping-cart"></i> 
            {% if session.role == 'customer' %}Meus Pedidos{% else %}Gerenciar Pedidos{% endif %}
        </h1>
    </div>
</div>

<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5><i class="fas fa-list"></i> Lista de Pedidos</h5>
        {% if session.role == 'customer' %}
        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#newOrderModal">
            <i class="fas fa-plus"></i> Novo Pedido
        </button>
        {% endif %}
    </div>
    <div class="card-body">
        {% if orders %}
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        {% if session.role != 'customer' %}
                        <th>Cliente ID</th>
                        <th>Funcionário ID</th>
                        {% endif %}
                        <th>Valor Total</th>
                        <th>Status</th>
                        <th>Data</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
                    {% for order in orders %}
                    <tr>
                        <td>
                            <a href="/order/{{ order[0] }}" class="text-decoration-none">
                                #{{ order[0] }}
                            </a>
                        </td>
                        {% if session.role != 'customer' %}
                        <td>
                            <a href="/user/{{ order[1] }}" class="text-decoration-none">
                                Cliente #{{ order[1] }}
                            </a>
                        </td>
                        <td>
                            {% if order[2] %}
                                <a href="/user/{{ order[2] }}" class="text-decoration-none">
                                    Func. #{{ order[2] }}
                                </a>
                            {% else %}
                                <span class="text-muted">Não atribuído</span>
                            {% endif %}
                        </td>
                        {% endif %}
                        <td>R$ {{ "%.2f"|format(order[3]) }}</td>
                        <td>
                            {% set status_class = {
                                'pending': 'warning',
                                'processing': 'info', 
                                'completed': 'success',
                                'cancelled': 'danger'
                            } %}
                            <span class="badge bg-{{ status_class.get(order[4], 'secondary') }}">
                                {{ order[4].title() }}
                            </span>
                        </td>
                        <td>{{ order[5].strftime('%d/%m/%Y %H:%M') if order[5] else 'N/A' }}</td>
                        <td>
                            <a href="/order/{{ order[0] }}" class="btn btn-sm btn-primary">
                                <i class="fas fa-eye"></i> Ver
                            </a>
                            {% if session.role in ['admin', 'employee'] %}
                            <button class="btn btn-sm btn-warning" onclick="updateOrderStatus('{{ order[0] }}', '{{ order[4] }}')">
                                <i class="fas fa-edit"></i> Status
                            </button>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-4">
            <i class="fas fa-shopping-cart fa-3x text-muted mb-3"></i>
            <h5>Nenhum pedido encontrado</h5>
            <p class="text-muted">
                {% if session.role == 'customer' %}
                    Você ainda não fez nenhum pedido.
                {% else %}
                    Não há pedidos para exibir.
                {% endif %}
            </p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Order Status Update Modal -->
{% if session.role in ['admin', 'employee'] %}
<div class="modal fade" id="statusModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Atualizar Status do Pedido</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="statusForm">
                    <input type="hidden" id="orderId">
                    <div class="mb-3">
                        <label for="newStatus" class="form-label">Novo Status</label>
                        <select class="form-select" id="newStatus" required>
                            <option value="pending">Pendente</option>
                            <option value="processing">Processando</option>
                            <option value="completed">Concluído</option>
                            <option value="cancelled">Cancelado</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="saveOrderStatus()">Salvar</button>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% if session.role == 'customer' %}
<!-- Modal para novo pedido -->
<div class="modal fade" id="newOrderModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Novo Pedido</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form id="newOrderForm">
        <div class="modal-body">
          <table class="table table-bordered" id="orderItemsTable">
            <thead>
              <tr>
                <th>Produto</th>
                <th>Quantidade</th>
                <th>Ações</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>
                  <select class="form-select productSelect" required>
                    {% for product in products %}
                    <option value="{{ product[0] }}">{{ product[1] }} - R$ {{ "%.2f"|format(product[3]) }}</option>
                    {% endfor %}
                  </select>
                </td>
                <td>
                  <input type="number" class="form-control quantityInput" min="1" value="1" required>
                </td>
                <td>
                  <button type="button" class="btn btn-danger btn-sm removeRowBtn">Remover</button>
                </td>
              </tr>
            </tbody>
          </table>
          <button type="button" class="btn btn-secondary btn-sm" id="addItemBtn">
            <i class="fas fa-plus"></i> Adicionar Item
          </button>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-success">Criar Pedido</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endif %}


{% endblock %}

{% block extra_js %}
<script>
// Vulnerable functions without proper CSRF protection
function updateOrderStatus(orderId, currentStatus) {
    document.getElementById('orderId').value = orderId;
    document.getElementById('newStatus').value = currentStatus;
    
    const modal = new bootstrap.Modal(document.getElementById('statusModal'));
    modal.show();
}

function saveOrderStatus() {
    const orderId = document.getElementById('orderId').value;
    const newStatus = document.getElementById('newStatus').value;
    
    // Vulnerable: No CSRF token, direct API call
    fetch('/api/update_order_status', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            order_id: orderId,
            status: newStatus
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Erro: ' + (data.error || 'Erro desconhecido'));
        }
    })
    .catch(error => {
        alert('Erro na requisição: ' + error);
    });
}

// Simulate CSRF attack demonstration
function demonstrateCSRF() {
    alert('Demonstração CSRF: Um site malicioso poderia fazer requisições em seu nome sem tokens CSRF!');
    
    // Example of how a malicious site could exploit this
    const maliciousForm = document.createElement('form');
    maliciousForm.method = 'POST';
    maliciousForm.action = '/api/update_order_status';
    maliciousForm.style.display = 'none';
    
    const orderInput = document.createElement('input');
    orderInput.name = 'order_id';
    orderInput.value = '1';
    
    const statusInput = document.createElement('input');
    statusInput.name = 'status';
    statusInput.value = 'cancelled';
    
    maliciousForm.appendChild(orderInput);
    maliciousForm.appendChild(statusInput);
    document.body.appendChild(maliciousForm);
    
    console.log('Formulário CSRF criado (não enviado):', maliciousForm);
}

document.addEventListener('DOMContentLoaded', function () {
    const addItemBtn = document.getElementById('addItemBtn');
    const orderItemsTable = document.getElementById('orderItemsTable').getElementsByTagName('tbody')[0];

    // Adicionar nova linha
    addItemBtn.addEventListener('click', () => {
        const newRow = document.createElement('tr');
        newRow.innerHTML = `
            <td>
              <select class="form-select productSelect" required>
                {% for product in products %}
                <option value="{{ product[0] }}">{{ product[1] }} - R$ {{ "%.2f"|format(product[3]) }}</option>
                {% endfor %}
              </select>
            </td>
            <td>
              <input type="number" class="form-control quantityInput" min="1" value="1" required>
            </td>
            <td>
              <button type="button" class="btn btn-danger btn-sm removeRowBtn">Remover</button>
            </td>
        `;
        orderItemsTable.appendChild(newRow);
    });

    // Remover linha
    orderItemsTable.addEventListener('click', (e) => {
        if (e.target.classList.contains('removeRowBtn')) {
            const row = e.target.closest('tr');
            row.remove();
        }
    });

    // Submeter formulário
    document.getElementById('newOrderForm').addEventListener('submit', function (e) {
        e.preventDefault();
        const rows = orderItemsTable.querySelectorAll('tr');
        const items = Array.from(rows).map(row => ({
            product_id: row.querySelector('.productSelect').value,
            quantity: row.querySelector('.quantityInput').value
        }));

        fetch('/api/create_order', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ items })
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) location.reload();
            else alert('Erro: ' + data.error);
        })
        .catch(err => alert('Erro na requisição: ' + err));
    });
});
</script>
{% endblock %}

