{% extends "base.html" %}

{% block title %}Administração - Vulnerable Sales Dashboard{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1><i class="fas fa-users-cog"></i> Gerenciar Usuários</h1>
        <p class="text-muted">Painel de administração de usuários do sistema</p>
    </div>
</div>

<!-- Access Control Vulnerability Warning -->
<div class="alert alert-danger">
    <i class="fas fa-exclamation-triangle"></i>
    <strong>Vulnerabilidade de Controle de Acesso:</strong> 
    Esta página deveria ser acessível apenas por administradores, mas qualquer usuário logado pode acessá-la!
</div>

<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5><i class="fas fa-users"></i> Lista de Usuários</h5>
        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addUserModal">
            <i class="fas fa-user-plus"></i> Adicionar Usuário
        </button>
    </div>
    <div class="card-body">
        {% if users %}
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>Usuário</th>
                        <th>Senha</th>
                        <th>Email</th>
                        <th>Função</th>
                        <th>Criado em</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                    <tr>
                        <td>
                            <a href="/user/{{ user[0] }}" class="text-decoration-none">
                                #{{ user[0] }}
                            </a>
                        </td>
                        <td>{{ user[1] }}</td>
                        <td>
                            <!-- Vulnerability: Displaying plain text passwords -->
                            <span class="text-danger">{{ user[2] }}</span>
                            <small class="text-muted d-block">⚠️ Senha em texto plano!</small>
                        </td>
                        <td>{{ user[3] }}</td>
                        <td>
                            {% set role_class = {
                                'admin': 'danger',
                                'employee': 'warning', 
                                'customer': 'info'
                            } %}
                            <span class="badge bg-{{ role_class.get(user[4], 'secondary') }}">
                                {{ user[4].title() }}
                            </span>
                        </td>
                        <td>{{ user[5].strftime('%d/%m/%Y') if user[5] else 'N/A' }}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="editUser('{{ user[0] }}', '{{ user[1] }}', '{{ user[3] }}', '{{ user[4] }}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteUser('{{ user[0] }}', '{{ user[1] }}')">
                                <i class="fas fa-trash"></i>
                            </button>
                            <a href="/user/{{ user[0] }}" class="btn btn-sm btn-info">
                                <i class="fas fa-eye"></i>
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-4">
            <i class="fas fa-users fa-3x text-muted mb-3"></i>
            <h5>Nenhum usuário encontrado</h5>
        </div>
        {% endif %}
    </div>
</div>

<!-- Add User Modal (Vulnerable) -->
<div class="modal fade" id="addUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Adicionar Usuário</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addUserForm" method="POST" action="/api/add_user">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="username" class="form-label">Nome de Usuário</label>
                        <input type="text" class="form-control" id="username" name="username" required>
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label">Senha</label>
                        <input type="password" class="form-control" id="password" name="password" required>
                        <small class="text-danger">⚠️ Será armazenada em texto plano!</small>
                    </div>
                    <div class="mb-3">
                        <label for="email" class="form-label">Email</label>
                        <input type="email" class="form-control" id="email" name="email" required>
                    </div>
                    <div class="mb-3">
                        <label for="role" class="form-label">Função</label>
                        <select class="form-select" id="role" name="role" required>
                            <option value="customer">Cliente</option>
                            <option value="employee">Funcionário</option>
                            <option value="admin">Administrador</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-success">Adicionar Usuário</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit User Modal -->
<div class="modal fade" id="editUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Editar Usuário</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editUserForm">
                <div class="modal-body">
                    <input type="hidden" id="editUserId">
                    <div class="mb-3">
                        <label for="editUsername" class="form-label">Nome de Usuário</label>
                        <input type="text" class="form-control" id="editUsername" required>
                    </div>
                    <div class="mb-3">
                        <label for="editEmail" class="form-label">Email</label>
                        <input type="email" class="form-control" id="editEmail" required>
                    </div>
                    <div class="mb-3">
                        <label for="editRole" class="form-label">Função</label>
                        <select class="form-select" id="editRole" required>
                            <option value="customer">Cliente</option>
                            <option value="employee">Funcionário</option>
                            <option value="admin">Administrador</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="saveUserChanges()">Salvar Alterações</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Vulnerable JavaScript functions
function editUser(id, username, email, role) {
    document.getElementById('editUserId').value = id;
    document.getElementById('editUsername').value = username;
    document.getElementById('editEmail').value = email;
    document.getElementById('editRole').value = role;
    
    const modal = new bootstrap.Modal(document.getElementById('editUserModal'));
    modal.show();
}

function saveUserChanges() {
    const id = document.getElementById('editUserId').value;
    const username = document.getElementById('editUsername').value;
    const email = document.getElementById('editEmail').value;
    const role = document.getElementById('editRole').value;
    
    // Vulnerable: No CSRF protection, no proper authorization check
    fetch('/api/update_user', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            id: id,
            username: username,
            email: email,
            role: role
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Erro: ' + (data.error || 'Erro desconhecido'));
        }
    })
    .catch(error => {
        alert('Erro na requisição: ' + error);
    });
}

function deleteUser(id, username) {
    if (confirm(`Tem certeza que deseja excluir o usuário "${username}"?`)) {
        // Vulnerable: No CSRF protection
        fetch('/api/delete_user', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                id: id
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Erro: ' + (data.error || 'Erro desconhecido'));
            }
        })
        .catch(error => {
            alert('Erro na requisição: ' + error);
        });
    }
}

// Demonstrate password visibility vulnerability
document.addEventListener('DOMContentLoaded', function() {
    // Highlight password vulnerability
    const passwordCells = document.querySelectorAll('td .text-danger');
    passwordCells.forEach(cell => {
        cell.addEventListener('click', function() {
            alert('Vulnerabilidade: Senhas visíveis em texto plano! Em um sistema real, isso seria um risco crítico de segurança.');
        });
    });
});
</script>
{% endblock %}

